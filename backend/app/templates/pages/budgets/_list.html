{% from "macros/components.html" import progress, badge, empty_state %}
{% from "macros/forms.html" import csrf_input %}

{% if budgets %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
  {% for budget in budgets %}
  {% set spent = (budget.current_usage_cents or 0) / 100 %}
  {% set amount = (budget.limit_cents or 0) / 100 %}
  {% set percentage = (spent / amount * 100) | round | int if amount > 0 else 0 %}
  {% set warning_pct = ((budget.warning_threshold_cents or 0) / budget.limit_cents * 100) | round | int if budget.limit_cents else 80 %}

  <div class="rounded-lg border bg-card p-6" id="budget-{{ budget.id }}">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h3 class="font-semibold">{{ budget.name }}</h3>
        <p class="text-sm text-muted-foreground capitalize">{{ budget.period_type }}</p>
      </div>
      <div class="flex items-center gap-2">
        {% if budget.auto_renew %}
        {{ badge('Auto-renew', variant='secondary') }}
        {% endif %}
      </div>
    </div>

    <div class="space-y-3">
      <div class="flex items-baseline justify-between">
        <span class="text-2xl font-bold">${{ spent | round(2) }}</span>
        <span class="text-sm text-muted-foreground">of ${{ amount | round(2) }}</span>
      </div>

      <div class="relative h-2 w-full overflow-hidden rounded-full bg-secondary/20">
        <div
          class="h-full transition-all progress-bar {% if percentage >= 100 %}bg-destructive{% elif percentage >= warning_pct %}bg-yellow-500{% else %}bg-primary{% endif %}"
          style="width: {{ [percentage, 100] | min }}%"
        ></div>
      </div>

      <p class="text-sm text-muted-foreground">
        {{ percentage }}% used
        {% if percentage >= 100 %}
        <span class="text-destructive"> - Budget exceeded</span>
        {% elif percentage >= warning_pct %}
        <span class="text-yellow-600 dark:text-yellow-400"> - Warning threshold reached</span>
        {% endif %}
      </p>
    </div>

    <div class="flex items-center gap-2 mt-4 pt-4 border-t">
      <button
        type="button"
        onclick="editBudget('{{ budget.id }}')"
        class="text-sm text-muted-foreground hover:text-foreground"
      >
        Edit
      </button>
      <button
        type="button"
        hx-delete="/budgets/{{ budget.id }}"
        hx-target="#budget-{{ budget.id }}"
        hx-swap="outerHTML swap:0.3s"
        hx-confirm="Are you sure you want to delete this budget?"
        class="text-sm text-destructive hover:text-destructive/80"
      >
        Delete
      </button>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
{{ empty_state(
  title='No budgets',
  description='Create a budget to track and limit your spending',
  icon='<svg class="h-12 w-12 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>'
) }}
{% endif %}
